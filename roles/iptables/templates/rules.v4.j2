# Generated by m.kucherenko
*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT DROP [0:0]
:incoming-ssh - [0:0]
:incoming-local - [0:0]
:incoming-local-wide - [0:0]
:incoming-external - [0:0]
:valid-states - [0:0]
:outgoing-services - [0:0]

-A INPUT -i lo -m comment --comment "Accept all on loopback" -j ACCEPT
-A INPUT -m conntrack --ctstate INVALID -j DROP
-A INPUT -j valid-states
-A INPUT -p tcp -m tcp --dport 22 -j incoming-ssh

-A INPUT -p tcp -m multiport --dports 80,443 -m comment --comment Web -j {% if external_connections | default('false') | bool %}incoming-external{% else %}incoming-local-wide{% endif %}{{ "" }}

-A INPUT -p vrrp -m comment --comment VRRP -j incoming-local
-A INPUT -p icmp -m comment --comment ICMP -j incoming-local

{% if rsyslog_server | default(false) | bool %}
{% if rsyslog_server_tcp | default(false) | bool %}
-A INPUT -p tcp -m tcp --dport 514 -m comment --comment "RSyslog TCP" -j incoming-local
{% endif %}
{% if rsyslog_server_udp | default(false) | bool %}
-A INPUT -p udp -m udp --dport 514 -m comment --comment "RSyslog UDP" -j incoming-local
{% endif %}
{% endif %}

{% if inventory_hostname in groups['dev'] %}
-A INPUT -m conntrack --ctstate RELATED,NEW,ESTABLISHED -j incoming-local
{% else %}
{% if inventory_hostname in groups['dns_servers'] %}
-A INPUT -p udp -m udp --dport 53 -m comment --comment DNS -j incoming-local-wide
{% if dnsmasq_exporter_enabled | default(false) | bool %}
-A INPUT -p tcp -m tcp --dport 9153 -m comment --comment dnsmasq_exporter -j incoming-local
{% endif %}
{% endif %}

{% if inventory_hostname in groups['monitoring_servers'] %}
#-A INPUT -p tcp -m tcp --dport 9090 -m comment --comment Prometheus -j incoming-local
#-A INPUT -p tcp -m tcp --dport {{ alertmanager_port }} -m comment --comment Alertmanager -j incoming-local
#-A INPUT -p tcp -m tcp --dport {{ alertmanager_bot_port }} -m comment --comment Alertmanager-bot -j incoming-local
-A INPUT -p tcp -m tcp --dport 3000 -m comment --comment Grafana -j incoming-local
{% endif %}

{% for host in groups['dev'] %}
-A INPUT -s {{ dev_public_vip_ip }}/32 -j DROP
-A INPUT -s {{ dev_private_vip_ip }}/32 -j DROP
-A INPUT -s {{ lookup('dig', host + '.local') }}/32 -j DROP
{% endfor %}

{% if inventory_hostname in groups['memcached_servers'] %}
-A INPUT -p tcp -m tcp --dport {{ memcached_port | default(11211) }} -m comment --comment Memcached -j incoming-local
-A INPUT -p tcp -m tcp --dport 9150 -m comment --comment memcached_exporter -j incoming-local
{% endif %}

{% if inventory_hostname in groups['db_servers'] %}
-A INPUT -p tcp -m multiport --dports 3306,4444,4567,4568,9200 -m comment --comment "MySQL/Galera TCP" -j incoming-local
-A INPUT -p udp -m udp --dport 4567 -m comment --comment "MySQL/Galera UDP" -j incoming-local
-A INPUT -p tcp -m tcp --dport 9104 -m comment --comment mysqld_exporter -j incoming-local
{% endif %}

{% if inventory_hostname in groups['redis_servers'] %}
-A INPUT -p tcp -m multiport --dports {{ redis_bind_port | default(6379) }},16379 -m comment --comment Redis -j incoming-local
-A INPUT -p tcp -m tcp --dport 9121 -m comment --comment redis_exporter -j incoming-local
{% endif %}

{% if inventory_hostname in groups['raspberry_pi'] %}
-A INPUT -p tcp -m tcp --dport 9243 -m comment --comment rpi_exporter -j incoming-local
{% endif %}

{% if inventory_hostname in groups['marusya_skill'] %}
-A INPUT -p tcp -m tcp --dport {{ marusya_skill_port | default(5000) }} -m comment --comment "Marusya skill" -j incoming-local
-A INPUT -p tcp -m tcp --dport {{ marusya_skill_port_dev | default(8080) }} -m comment --comment "Marusya skill DEV" -j incoming-local
{% endif %}

{% if inventory_hostname in groups['smarthome'] %}
-A INPUT -p tcp -m tcp --dport {{ smarthome_port | default(4050) }} -m comment --comment "SmartHome API" -j incoming-local
-A INPUT -p tcp -m tcp --dport {{ smarthome_port_dev | default(4060) }} -m comment --comment "SmartHome API DEV" -j incoming-local
{% endif %}

{% if inventory_hostname in groups['research_hosts'] %}
-A INPUT -p tcp -m tcp --dport {{ jupyter_port | default(8888) }} -m comment --comment "Jupyter Notebook" -j incoming-local
{% endif %}

{% if inventory_hostname in groups['razumator'] %}
-A INPUT -p tcp -m tcp --dport {{ razumator_api_port | default(10001) }} -m comment --comment "Razumator API" -j incoming-local
{% endif %}

-A INPUT -p tcp -m tcp --dport 9100 -m comment --comment node_exporter -j incoming-local
-A INPUT -p tcp -m tcp --dport 9000 -m comment --comment "HAProxy dashboard" -j incoming-local
-A INPUT -p tcp -m tcp --dport 9101 -m comment --comment haproxy_exporter -j incoming-local

{% if open_proxy_ports | default(false) | bool %}
-A INPUT -p tcp -m tcp --dport {{ memcached_proxy_port | default(11311) }} -m comment --comment memcached_proxy -j incoming-local
-A INPUT -p tcp -m multiport --dports {{ mariadb_proxy_port | default(3307) }},{{ mariadb_proxy_port_ro | default(3308) }} -m comment --comment mysqld_proxy -j incoming-local
-A INPUT -p tcp -m tcp --dport {{ redis_proxy_port | default(6380) }} -m comment --comment redis_proxy -j incoming-local
{% endif %}

{% if inventory_hostname in groups['web_servers'] %}
-A INPUT -p tcp -m tcp --dport 9113 -m comment --comment "nginx_exporter" -j incoming-local
{% endif %}
{% endif %}

-A OUTPUT -o lo -m comment --comment "Accept all on loopback" -j ACCEPT
-A OUTPUT -j valid-states
-A OUTPUT -j outgoing-services

-A incoming-ssh -s 192.168.8.0/24 -m conntrack --ctstate NEW,ESTABLISHED -m comment --comment "Local SSH" -j ACCEPT
-A incoming-ssh -s 192.168.9.0/24 -m conntrack --ctstate NEW,ESTABLISHED -m comment --comment "Local VPN SSH" -j ACCEPT
-A incoming-ssh -s 192.168.2.0/24 -m conntrack --ctstate NEW,ESTABLISHED -m comment --comment "Golovanova VPN SSH" -j ACCEPT
-A incoming-ssh -j DROP

-A incoming-local-wide -s 192.168.8.0/24 -m conntrack --ctstate NEW,ESTABLISHED -m comment --comment "Local" -j ACCEPT
-A incoming-local-wide -s 192.168.9.0/24 -m conntrack --ctstate NEW,ESTABLISHED -m comment --comment "Local VPN" -j ACCEPT
-A incoming-local-wide -s 192.168.2.0/24 -m conntrack --ctstate NEW,ESTABLISHED -m comment --comment "Golovanova VPN" -j ACCEPT
-A incoming-local-wide -j DROP

-A incoming-local -s 192.168.8.0/24 -m conntrack --ctstate NEW,ESTABLISHED -j ACCEPT
-A incoming-local -j DROP

{% for cidr in external_blacklist | default([]) %}
-A incoming-external -s {{ cidr }} -j DROP
{% endfor %}
-A incoming-external -m conntrack --ctstate NEW,ESTABLISHED -j ACCEPT
-A incoming-external -j DROP

-A valid-states -p tcp -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A valid-states -p udp -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A valid-states -p icmp -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A valid-states -p vrrp -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A valid-states -j RETURN

-A outgoing-services -p tcp -j ACCEPT
-A outgoing-services -p udp -j ACCEPT
-A outgoing-services -p icmp -j ACCEPT
-A outgoing-services -p vrrp -j ACCEPT
-A outgoing-services -j DROP

COMMIT
